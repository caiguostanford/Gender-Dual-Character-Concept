---
title: "Study 1"
author: "Cai Guo"
date: "10/18/2017"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
---

```{r message=FALSE, warning=FALSE, include=FALSE, results='hide'}
library(ggplot2)
library(tidyr)
library(dplyr)
library(lmerTest)
library(car)
library(lme4)
library(MASS)
library(RePsychLing)
dt <- read.csv("~/Desktop/Stanford/Dual Character Concepts/Dual Character Concept Data/Study 1.csv")
```

#Demographics
```{r message=FALSE, warning=FALSE}
#1 = Female, 2 = Male, 3 = Other
prop.table(table(dt$ParticipantGender))
#If there were participants who identified as Other, what specific identity they provided:
summary(dt$GenderSpecific)
#Age
summary(dt$Age)
```

#Clean the dataset and turn the dataset into long-form for analyses
```{r message=FALSE, warning=FALSE, include=FALSE, results='hide'}
dt_tidy = dt %>%
  mutate(index=rownames(dt)) %>%
  gather(variable, value, Artist.I:Woman.Tr) %>%
  group_by(index) %>%
  separate(variable, into=c("Concept", "Statement"))

dt_tidy$Statement = as.factor(dt_tidy$Statement)
levels(dt_tidy$Statement)[levels(dt_tidy$Statement)=="I"] <- "Good"
levels(dt_tidy$Statement)[levels(dt_tidy$Statement)=="Tr"] <- "True"
```

#Study 1

##Compare Man and Woman for Study1
```{r message=FALSE, warning=FALSE}
#Since the study is a within-subject design, we treat "subject" (known as index in the model) as a random effect. Moreover, since there was only one item in Man and Woman respectively, we do not include specific item as a random effect [such modeling isn't possible], but will do so for later analyses where dual-character and control concepts are involved. 

#interaction
##We first fitted a maximal random-effects model with a by-subject random intercept and a by-subject random slope for the interaction b/w Concept and Statement Type. 
lmg = lmer(value~Concept*Statement+(1+Concept*Statement|index), data = subset(dt_tidy, Concept == "Man"|Concept == "Woman"))

## the maximal model with by-subject random slope for the interaction between Concept and Statement Type couldn't be identified because the number of observations were fewer than the possible random effects -- we therefore added separate by-subject random slopes for Concept and Statement Type.

lmg = lmer(value~Concept*Statement+(1+Concept+Statement|index), data = subset(dt_tidy, Concept == "Man"|Concept == "Woman"))
anova(lmg)
summary(lmg)

lsmeans(lmg, pairwise~Concept*Statement)
```
The results showed that Man and Woman did not differ in any aspects -- therefore, we will combined Man and Woman into the Gender category in subsequent analyses. 

##The model testing the effects of statement type and concept type and their interaction [when "man" and "woman" combined into gender]
```{r message=FALSE, warning=FALSE}
#sort specific concepts into their respective kinds

dt_c = within(dt_tidy, {Type = ifelse(Concept %in% c("Artist", "Rock", "Criminal", "Soldier", "Teacher", "Poem", "Love", "Friend", "Scientist", "Mother", "Mentor", "Comedian", "Minister", "Theory", "Boyfriend", "Argument", "Sculpture", "ArtMuseum", "Musician", "Novel", "Teacher"), "DualCharacter", ifelse(Concept %in% c("Optician", "Baker", "Blog", "Doorman", "Caseworker", "TOC", "Tailor", "Bartender", "Rustling", "Welder", "Catalog", "Chair", "Firefighter", "Uncle", "Cashier", "Stroller", "Obituary", "Cousin", "Waitress", "Mayor"), "Control", "Gender"))})

##Test interaction
## Statement = Good vs. True
## Type = Dual-Character vs. Control. vs. Gender
## Random Effects = 1) by-subject random intercept and randon slopes for the interaction between Concept Type and Statement Type. 2) by-concept random intercept and slope for Statement (Concept type is a between-unit factor for specific concepts, and therefore cannot have a by-concept random slope).

## We fitted the maximal random effects structure
dt_c$Type = as.factor(dt_c$Type)
dt_c$Statement = as.factor(dt_c$Statement)
lm1 = lmer(value~Type*Statement+(1+Statement|Concept)+(1+Type*Statement|index), dt_c) #Type is between-unit for Item. Therefore we did not fit any by-item random slope for Type or for the interaction between Type and Statement.
anova(lm1)
summary(lm1)

##The model doesn't converge as shown in the summary

##We therefore followed Bates et al. (2015) to reduce the dimensionality of the random effects structure to solve the overfitting problem. 

lm2 = lmer(value~Type*Statement+(1+Statement||Concept)+(1+Type*Statement||index), dt_c)
summary(lm2)
summary(rePCA(lm2))

##still failed to converge. and the PCA test showed that the random intercepts explained 0% variance. We therefore conducted the following model:

lm3 = lmer(value~Type*Statement+(0+Statement||Concept)+(0+Type:Statement||index), dt_c)
summary(lm3)
summary(rePCA(lm3))

##still failed to converge, and the PCA showed that the by-index (subject) random slopes for the interaction might not be necessary because all the variances were explained by the first three combinations of the interaction between concept and statement types. We therefore removed the interaction term and further simplified the model with separate by-subject random slopes for concept type and statement type :

lm4 = lmer(value~Type*Statement+(0+Statement||Concept)+(0+Type+Statement||index), dt_c)
summary(lm4)
summary(rePCA(lm4))

##The model above now successfully converged. We then added the correlation parameters back to see if this would increase model fit:

lm5 = lmer(value~Type*Statement+(0+Statement|Concept)+(0+Type+Statement|index), dt_c)

anova(lm4, lm5)

##The model comparison showed that lm5 is significantly better than lm4 -- therefore for the final model, we included the correlation parameters

##get the info from the final model
anova(lm5)
summary(lm5)

##test main effects 

##main effect of concept type
lmt = lmer(value~Type+(0+Statement|Concept)+(0+Type+Statement|index), dt_c)
anova(lmt)
summary(lmt)

##change reference level to interpret the main effect
lmt1 = lmer(value~relevel(Type, ref = "DualCharacter")+(0+Statement|Concept)+(0+relevel(Type, ref = "DualCharacter")+Statement|index), dt_c)
summary(lmt1)

##main effect of statement type
lms = lmer(value~Statement+(0+Statement|Concept)+(0+Type+Statement|index), dt_c)
anova(lms)
summary(lms)
```

##Comparing different types of concepts for only "good" statement
```{r message=FALSE, warning=FALSE}
#good
lm2g = lmer(value~Type+(1|Concept)+(0+Type|index), data = subset(dt_c, Statement == "Good"))
anova(lm2g)
summary(lm2g)

#change reference level to get all comparisons
dt_c$Type = relevel(dt_c$Type, ref = "DualCharacter")
lm2g = lmer(value~Type+(1|Concept)+(0+Type|index), data = subset(dt_c, Statement == "Good"))
summary(lm2g)
```

The results showed that the three types of concepts did not differ from one another in ratings of "good" statements.

##Comparing different types of concepts for only "true" statements
```{r message=FALSE, warning=FALSE}
#true
lm2 = lmer(value~Type+(1|Concept)+(0+Type|index), data = subset(dt_c, Statement == "True"))
anova(lm2)
summary(lm2)

#change reference level
dt_c$Type = relevel(dt_c$Type, ref = "Gender")
lm2 = lmer(value~Type+(1|Concept)+(0+Type|index), data = subset(dt_c, Statement == "True"))
summary(lm2)
```

####Bar Graph for Statements and Concepts (error bars represent 95% confidence intervals)
```{r message=FALSE, warning=FALSE, echo=FALSE}
sem <- function(x) {sd(x, na.rm=TRUE) / sqrt(length(x))}

ci <- function(x) {qt(.975, df=length(x)-1)*sem(x)}

aggc1 <- dt_c %>%
  group_by(Type, Statement) %>%
  summarise(Mean = mean(value,na.rm=T),
            se = ci(value), #confidence interval
            sd = sd(value),
            upper = Mean + se,
            lower = Mean - se)

ggplot(aggc1,aes(x=Type, y=Mean, fill=Statement, label = round(Mean, digits=2))) +
  geom_bar(position="dodge", stat="identity", col = "black") + scale_fill_manual(values=c("grey", "white")) +
  geom_errorbar(   aes( ymax=upper, ymin=lower ) , 
                     		width   =.25,
	                    	linetype="solid", position=position_dodge(.9)
	                    	) + 
  theme_bw() + ggtitle("Ratings of Statements by Concept and Statement Type") + geom_text(size = 3, position = position_dodge(width=.9), vjust=10)

#get descriptives (e.g. means and SDs)
print(aggc1)
```

####Rank Order Graph for True Statements
```{r}
d_true = dt_c %>%
  filter(Statement=="True") %>%
  spread(Statement, value)

agg5 <- d_true %>%
  group_by(Concept, Type) %>%
  summarise(Mean = mean(True,na.rm=T))

ggplot(agg5, aes(x=reorder(Concept, Mean), y=Mean, fill = Type, label = round(Mean, digits=2))) + geom_bar(width = .5, stat="identity",position = position_dodge(width = .5)) + ggtitle("Rank Order of True Statement Ratings by Concept") + scale_x_discrete(name = "Concept") + scale_fill_manual(values = c("grey", "black", "beige")) +  scale_y_continuous(name="Mean Ratings for True Statements", breaks = c(1:7), sec.axis = sec_axis(~.*1, name = "Mean Rating for True Statements", breaks = c(1:7)))+ coord_flip(ylim=c(1,7)) + theme (axis.text.x = element_text(vjust=0.7, size=8, angle=0)) + theme (axis.text.y = element_text(vjust=0.7, size=6, angle=0))
```
